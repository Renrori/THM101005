<!-- Begin page -->
<div class="wrapper" id="app">


	<!-- ========== Topbar Start ========== -->
	<!-- ========== Topbar End ========== -->
	<!-- ========== Horizontal Menu Start ========== -->
	<div class="topnav">
		<div class="container-fluid">
			<nav class="navbar navbar-expand-lg">
				<div class="collapse navbar-collapse" id="topnav-menu-content">
					<ul class="navbar-nav">
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle arrow-none" href="#" id="topnav-dashboards" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<i class="uil-dashboard"></i>Dashboards <div class="arrow-down"></div>
							</a>
							<div class="dropdown-menu" aria-labelledby="topnav-dashboards">
								<a href="dashboard-analytics.html" class="dropdown-item">Analytics</a>
								<a href="index.html" class="dropdown-item">Ecommerce</a>
								<a href="dashboard-projects.html" class="dropdown-item">Projects</a>
								<a href="dashboard-crm.html" class="dropdown-item">CRM</a>
								<a href="dashboard-wallet.html" class="dropdown-item">E-Wallet</a>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle arrow-none" href="#" id="topnav-apps" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<i class="uil-apps"></i>Apps <div class="arrow-down"></div>
							</a>
							<div class="dropdown-menu" aria-labelledby="topnav-apps">
								<a href="apps-calendar.html" class="dropdown-item">Calendar</a>
								<a href="apps-chat.html" class="dropdown-item">Chat</a>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-crm" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										CRM <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-crm">
										<a href="crm-projects.html" class="dropdown-item">Project</a>
										<a href="crm-orders-list.html" class="dropdown-item">Orders List</a>
										<a href="crm-clients.html" class="dropdown-item">Clients</a>
										<a href="crm-management.html" class="dropdown-item">Management</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-ecommerce" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Ecommerce <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-ecommerce">
										<a href="apps-ecommerce-products.html" class="dropdown-item">Products</a>
										<a href="apps-ecommerce-products-details.html" class="dropdown-item">Products Details</a>
										<a href="apps-ecommerce-orders.html" class="dropdown-item">Orders</a>
										<a href="apps-ecommerce-orders-details.html" class="dropdown-item">Order Details</a>
										<a href="apps-ecommerce-customers.html" class="dropdown-item">Customers</a>
										<a href="apps-ecommerce-shopping-cart.html" class="dropdown-item">Shopping Cart</a>
										<a href="apps-ecommerce-checkout.html" class="dropdown-item">Checkout</a>
										<a href="apps-ecommerce-sellers.html" class="dropdown-item">Sellers</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-email" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Email <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-email">
										<a href="apps-email-inbox.html" class="dropdown-item">Inbox</a>
										<a href="apps-email-read.html" class="dropdown-item">Read Email</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-project" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Projects <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-project">
										<a href="apps-projects-list.html" class="dropdown-item">List</a>
										<a href="apps-projects-details.html" class="dropdown-item">Details</a>
										<a href="apps-projects-gantt.html" class="dropdown-item">Gantt</a>
										<a href="apps-projects-add.html" class="dropdown-item">Create Project</a>
									</div>
								</div>
								<a href="apps-social-feed.html" class="dropdown-item">Social Feed</a>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-tasks" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Tasks <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-tasks">
										<a href="apps-tasks.html" class="dropdown-item">List</a>
										<a href="apps-tasks-details.html" class="dropdown-item">Details</a>
										<a href="apps-kanban.html" class="dropdown-item">Kanban Board</a>
									</div>
								</div>
								<a href="apps-file-manager.html" class="dropdown-item">File Manager</a>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle arrow-none" href="#" id="topnav-pages" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<i class="uil-copy-alt"></i>Pages <div class="arrow-down"></div>
							</a>
							<div class="dropdown-menu" aria-labelledby="topnav-pages">
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-auth" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Authenitication <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-auth">
										<a href="pages-login.html" class="dropdown-item">Login</a>
										<a href="pages-login-2.html" class="dropdown-item">Login 2</a>
										<a href="pages-register.html" class="dropdown-item">Register</a>
										<a href="pages-register-2.html" class="dropdown-item">Register 2</a>
										<a href="pages-logout.html" class="dropdown-item">Logout</a>
										<a href="pages-logout-2.html" class="dropdown-item">Logout 2</a>
										<a href="pages-recoverpw.html" class="dropdown-item">Recover Password</a>
										<a href="pages-recoverpw-2.html" class="dropdown-item">Recover Password 2</a>
										<a href="pages-lock-screen.html" class="dropdown-item">Lock Screen</a>
										<a href="pages-lock-screen-2.html" class="dropdown-item">Lock Screen 2</a>
										<a href="pages-confirm-mail.html" class="dropdown-item">Confirm Mail</a>
										<a href="pages-confirm-mail-2.html" class="dropdown-item">Confirm Mail 2</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-error" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Error <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-error">
										<a href="pages-404.html" class="dropdown-item">Error 404</a>
										<a href="pages-404-alt.html" class="dropdown-item">Error 404-alt</a>
										<a href="pages-500.html" class="dropdown-item">Error 500</a>
									</div>
								</div>
								<a href="pages-starter.html" class="dropdown-item">Starter Page</a>
								<a href="pages-preloader.html" class="dropdown-item">With Preloader</a>
								<a href="pages-profile.html" class="dropdown-item">Profile</a>
								<a href="pages-profile-2.html" class="dropdown-item">Profile 2</a>
								<a href="pages-invoice.html" class="dropdown-item">Invoice</a>
								<a href="pages-faq.html" class="dropdown-item">FAQ</a>
								<a href="pages-pricing.html" class="dropdown-item">Pricing</a>
								<a href="pages-maintenance.html" class="dropdown-item">Maintenance</a>
								<a href="pages-timeline.html" class="dropdown-item">Timeline</a>
								<a href="landing.html" class="dropdown-item">Landing</a>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle arrow-none" href="#" id="topnav-components" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<i class="uil-package"></i>Components <div class="arrow-down"></div>
							</a>
							<div class="dropdown-menu" aria-labelledby="topnav-components">
								<a href="widgets.html" class="dropdown-item">Widgets</a>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-ui-kit" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Base UI 1 <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-ui-kit">
										<a href="ui-accordions.html" class="dropdown-item">Accordions</a>
										<a href="ui-alerts.html" class="dropdown-item">Alerts</a>
										<a href="ui-avatars.html" class="dropdown-item">Avatars</a>
										<a href="ui-badges.html" class="dropdown-item">Badges</a>
										<a href="ui-breadcrumb.html" class="dropdown-item">Breadcrumb</a>
										<a href="ui-buttons.html" class="dropdown-item">Buttons</a>
										<a href="ui-cards.html" class="dropdown-item">Cards</a>
										<a href="ui-carousel.html" class="dropdown-item">Carousel</a>
										<a href="ui-dropdowns.html" class="dropdown-item">Dropdowns</a>
										<a href="ui-embed-video.html" class="dropdown-item">Embed Video</a>
										<a href="ui-grid.html" class="dropdown-item">Grid</a>
										<a href="ui-list-group.html" class="dropdown-item">List Group</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-ui-kit2" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Base UI 2 <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-ui-kit2">
										<a href="ui-modals.html" class="dropdown-item">Modals</a>
										<a href="ui-notifications.html" class="dropdown-item">Notifications</a>
										<a href="ui-offcanvas.html" class="dropdown-item">Offcanvas</a>
										<a href="ui-placeholders.html" class="dropdown-item">Placeholders</a>
										<a href="ui-pagination.html" class="dropdown-item">Pagination</a>
										<a href="ui-popovers.html" class="dropdown-item">Popovers</a>
										<a href="ui-progress.html" class="dropdown-item">Progress</a>
										<a href="ui-ribbons.html" class="dropdown-item">Ribbons</a>
										<a href="ui-spinners.html" class="dropdown-item">Spinners</a>
										<a href="ui-tabs.html" class="dropdown-item">Tabs</a>
										<a href="ui-tooltips.html" class="dropdown-item">Tooltips</a>
										<a href="ui-typography.html" class="dropdown-item">Typography</a>
										<a href="ui-utilities.html" class="dropdown-item">Utilities</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-extended-ui" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Extended UI <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-extended-ui">
										<a href="extended-dragula.html" class="dropdown-item">Dragula</a>
										<a href="extended-range-slider.html" class="dropdown-item">Range Slider</a>
										<a href="extended-ratings.html" class="dropdown-item">Ratings</a>
										<a href="extended-scrollbar.html" class="dropdown-item">Scrollbar</a>
										<a href="extended-scrollspy.html" class="dropdown-item">Scrollspy</a>
										<a href="extended-treeview.html" class="dropdown-item">Treeview</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-forms" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Forms <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-forms">
										<a href="form-elements.html" class="dropdown-item">Basic Elements</a>
										<a href="form-advanced.html" class="dropdown-item">Form Advanced</a>
										<a href="form-validation.html" class="dropdown-item">Validation</a>
										<a href="form-wizard.html" class="dropdown-item">Wizard</a>
										<a href="form-fileuploads.html" class="dropdown-item">File Uploads</a>
										<a href="form-editors.html" class="dropdown-item">Editors</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-charts" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Charts <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-charts">
										<a href="charts-chartjs.html" class="dropdown-item">Chartjs</a>
										<a href="charts-brite.html" class="dropdown-item">Britecharts</a>
										<a href="charts-apex-line.html" class="dropdown-item">Apex Charts</a>
										<a href="charts-sparkline.html" class="dropdown-item">Sparklines</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-tables" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Tables <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-tables">
										<a href="tables-basic.html" class="dropdown-item">Basic Tables</a>
										<a href="tables-datatable.html" class="dropdown-item">Data Tables</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-icons" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										Icons <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-icons">
										<a href="icons-remixicons.html" class="dropdown-item">Remix Icons</a>
										<a href="icons-mdi.html" class="dropdown-item">Material Design</a>
										<a href="icons-unicons.html" class="dropdown-item">Unicons</a>
									</div>
								</div>
								<div class="dropdown">
									<a class="dropdown-item dropdown-toggle arrow-none" href="#" id="topnav-maps" role="button" data-bs-toggle="dropdown" aria-expanded="false">
										Maps <div class="arrow-down"></div>
									</a>
									<div class="dropdown-menu" aria-labelledby="topnav-maps">
										<a href="maps-google.html" class="dropdown-item">Google Maps</a>
										<a href="maps-vector.html" class="dropdown-item">Vector Maps</a>
									</div>
								</div>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle arrow-none" href="#" id="topnav-layouts" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<i class="uil-window"></i>Layouts <div class="arrow-down"></div>
							</a>
							<div class="dropdown-menu" aria-labelledby="topnav-layouts">
								<a href="layouts-vertical.html" class="dropdown-item" target="_blank">Vertical</a>
								<a href="layouts-detached.html" class="dropdown-item" target="_blank">Detached</a>
								<a href="layouts-full.html" class="dropdown-item" target="_blank">Full</a>
								<a href="layouts-fullscreen.html" class="dropdown-item" target="_blank">Fullscreen</a>
								<a href="layouts-hover.html" class="dropdown-item" target="_blank">Hover Menu</a>
								<a href="layouts-compact.html" class="dropdown-item" target="_blank">Compact Menu</a>
								<a href="layouts-icon-view.html" class="dropdown-item" target="_blank">Icon View</a>
							</div>
						</li>
					</ul>
				</div>
			</nav>
		</div>
	</div>
	<!-- ========== Horizontal Menu End ========== -->
	<!-- ============================================================== -->
	<!-- Start Page Content here -->
	<!-- ============================================================== -->

	<h3>ConnectionId: <span id="SelfID"></span></h3>
	<div class="content-page" style="margin-left:0px;">
		<div class="content">
			<!-- Start Content-->
			<div class="container-fluid">
				<div class="row">
					<!-- start chat users-->
					<div class="col-xxl-3 col-xl-6 order-xl-1">
						<div class="card">
							<div class="card-header p-0">
								<ul class="nav nav-tabs nav-bordered">
									<li class="nav-item">
										<a href="#UsersOn" data-bs-toggle="tab" aria-expanded="false" class="nav-link active py-2">
											上線
										</a>
									</li>
									<li class="nav-item">
										<a href="#UsersOff" data-bs-toggle="tab" aria-expanded="false" class="nav-link py-2">
											離線
										</a>
									</li>
								</ul>
							</div>
							<div class="tab-content">
								<div class="tab-pane show active card-body pb-0" id="UsersOn">
									<!-- start search box -->
									<div class="app-search">
									<form>
										<div class="mb-2 w-100 position-relative">
											<input type="search" class="form-control"
												   placeholder="People, groups & messages..." />
											<span class="mdi mdi-magnify search-icon"></span>
										</div>
									</form>
									</div>
									<!-- end search box -->
									<!-- users -->
									<div class="row">
										<div class="col">
											<div class="card-body py-0 mb-3 tab-pane fade show active"  data-simplebar style="max-height: 546px">
												<template v-for="user in UserOn">
													<a href="javascript:void(0);" class="text-body" @@click.prevent="switchConversation(user)">
														<div class="d-flex align-items-start mt-1 p-2" v-bind:class="{ 'bg-light':user.userId == currentChatUser.userId}">
															<div class="w-100 overflow-hidden">
																<h5 class="mt-0 mb-0 font-14">
																	<span class="float-end text-muted font-12">{{user.role}}</span>
																	{{user.name}}
																</h5>
																<p class="mt-1 mb-0 text-muted font-14 ">
																	<span class="w-25 float-end text-end">
																		<span class="badge badge-danger-lighten" :style="{'content-visibility':UnReadNotify(user.userId)}">新訊息</span>
																	</span>
																	<span class="w-75">{{user.connectionId}}</span>
																</p>
															</div>
														</div>
													</a>
												</template>
											</div> <!-- End col -->
										</div> <!-- end users -->
									</div>
								</div> <!-- end slimscroll-->

								<div class="tab-pane card-body pb-0" id="UsersOff">
									<!-- start search box -->
									<div class="app-search">
										<form>
											<div class="mb-2 w-100 position-relative">
												<input type="search" class="form-control"
													   placeholder="People, groups & messages..." />
												<span class="mdi mdi-magnify search-icon"></span>
											</div>
										</form>
									</div>
									<div class="row">
										<div class="col">
											<div class="card-body py-0 mb-3 tab-pane fade show active" data-simplebar style="max-height: 546px">
												<template v-for="user in UserOff">
													<a href="javascript:void(0);" class="text-body" @@click.prevent="switchConversation(user)">
														<div class="d-flex align-items-start mt-1 p-2" v-bind:class="{ 'bg-light':user.userId == currentChatUser.userId}">
															<div class="w-100 overflow-hidden">
																<h5 class="mt-0 mb-0 font-14">
																	<span class="float-end text-muted font-12">{{user.role}}</span>
																	{{user.name}}
																</h5>
																<p class="mt-1 mb-0 text-muted font-14">
																	<span class="w-25 float-end text-end">
																		<span class="badge badge-danger-lighten" :style="{'content-visibility':UnReadNotify(user.userId)}">新訊息</span>
																	</span>
																	<span class="w-75">{{user.connectionId}}</span>
																</p>
															</div>
														</div>
													</a>
												</template>
											</div> <!-- end slimscroll-->
										</div>
									</div>
								</div>
										
							</div> <!-- end tab content-->
							<!-- end card-body-->
						</div> <!-- end card-->
					</div>
					<!-- end chat users-->
					<!-- chat area -->
					<div class="col-xxl-6 col-xl-12 order-xl-2">
						<div class="card">
							<div class="card-body px-0 pb-0" style="height:580px">
								<ul id="messageList" class="conversation-list px-3" data-simplebar style="max-height: 554px">
									<template v-for="msg in displayMessage">
										<li class="clearfix" v-bind:class="{odd:msg.userId == thisUser.userId}">
											<div class="conversation-text">
												<div class="ctext-wrap">
													<i>{{msg.name}}</i>
													<p>{{msg.message}}</p>
												</div>
											</div>
										</li>
									</template>
								</ul>
							</div> <!-- end card-body -->
							<div class="card-body p-0">
								<div class="row">
									<div class="col">
										<div class="mt-2 bg-light p-3">
											<div class="row">
												<div class="col mb-2 mb-sm-0">
													<input type="text" class="form-control border-0" placeholder="Enter your text" required id="msgforcaller" v-model="message" @@keyup.enter="sendtoCaller">
													<div class="invalid-feedback">
														Please enter your messsage
													</div>
												</div>
												<div class="col-sm-auto">
													<div class="btn-group">
														<a href="#" class="btn btn-light"><i class="uil uil-paperclip"></i></a>
														<a href="#" class="btn btn-light"> <i class='uil uil-smile'></i> </a>
														<div class="d-grid">
															<button id="sendMsg" type="submit" class="btn btn-success chat-send" @@click="sendtoCaller"><i class='uil uil-message'></i></button>
														</div>
													</div>
												</div> <!-- end col -->
											</div> <!-- end row-->
										</div>
									</div> <!-- end col-->
								</div>
								<!-- end row -->
							</div>
						</div> <!-- end card -->
					</div>
					<!-- end chat area-->
					<!-- start user detail -->
					<div class="col-xxl-3 col-xl-6 order-xl-1 order-xxl-2">
						<div class="card">
							<div class="card-body">
								<div class="dropdown float-end">
									<a href="#" class="dropdown-toggle arrow-none card-drop" data-bs-toggle="dropdown" aria-expanded="false">
										<i class="mdi mdi-dots-horizontal"></i>
									</a>
									<div class="dropdown-menu dropdown-menu-end">
										<!-- item-->
										<a href="javascript:void(0);" class="dropdown-item">View full</a>
										<!-- item-->
										<a href="javascript:void(0);" class="dropdown-item">Edit Contact Info</a>
										<!-- item-->
										<a href="javascript:void(0);" class="dropdown-item">Remove</a>
									</div>
								</div>

								<div class="mt-3 text-center">
									<img src="assets/images/users/avatar-5.jpg" alt="shreyu"
										 class="img-thumbnail avatar-lg rounded-circle" />
									<h4>Shreyu N</h4>
									<button class="btn btn-primary btn-sm mt-1"><i class='uil uil-envelope-add me-1'></i>Send Email</button>
									<p class="text-muted mt-2 font-14">Last Interacted: <strong>Few hours back</strong></p>
								</div>

								<div class="mt-3">
									<hr class="" />

									<p class="mt-4 mb-1"><strong><i class='uil uil-at'></i> Email:</strong></p>
									<p>support@@coderthemes.com</p>

									<p class="mt-3 mb-1"><strong><i class='uil uil-phone'></i> Phone Number:</strong></p>
									<p>+1 456 9595 9594</p>

									<p class="mt-3 mb-1"><strong><i class='uil uil-location'></i> Location:</strong></p>
									<p>California, USA</p>

									<p class="mt-3 mb-1"><strong><i class='uil uil-globe'></i> Languages:</strong></p>
									<p>English, German, Spanish</p>

									<p class="mt-3 mb-2"><strong><i class='uil uil-users-alt'></i> Groups:</strong></p>
									<p class="mb-0">
										<span class="badge badge-success-lighten p-1 font-14">Work</span>
										<span class="badge badge-primary-lighten p-1 font-14">Friends</span>
									</p>
								</div>
							</div> <!-- end card-body -->
						</div> <!-- end card-->
					</div> <!-- end col -->
					<!-- end user detail -->
				</div> <!-- end row-->

			</div> <!-- container -->

		</div> <!-- content -->
	</div>

	<!-- ============================================================== -->
	<!-- End Page content -->
	<!-- ============================================================== -->

</div>
<!-- END wrapper -->
@section Scripts
	{
	<script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
	@*<script src="~/js/sendtocaller.js"></script>*@
	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<script>
		let app = Vue.createApp({
			data() {
				return {
					thisUser: {
						connectionId: "",
						name: "",
						role: "",
						userId: ""
					},
					signalr: {},
					UserOn: [],
					UserOff: [],
					onlineUsers: [],
					isSend: false,
					response: {},
					message: "",
					allMessage: [],
					currentChatUser: {
						name: "",
						connectionId: "",
						userId: "",
						role: ""
					},
					unReadUsers:[]
				};
			},
			computed: {
				displayMessage: function () {
					let self = this;
					var obj = self.allMessage.find(x => x.key == self.currentChatUser.userId);
					if (obj) {
						for(let m of obj.msg) m.read=true;
						self.signalr.invoke("ReadStatus", self.currentChatUser.userId);
						return obj.msg;
					}
					return [];
				}
			},
			mounted: function () {
				let _this = this;
				_this.signalr = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
				_this.signalr.start()
					.then(() => {
						console.log("connection");
						_this.signalr.invoke("UnRead");
					})
					.catch((err) => {
						console.log(err.toString());
					});
				_this.signalr.on("GetAllOnline", _this.getAllUsers);
				_this.signalr.on("UserIsOnline", _this.UserConnect);
				_this.signalr.on("GetAllOffline", _this.getOfflineUsers);
				_this.signalr.on("UserIsOffline", _this.UserDisConnect);
				_this.signalr.on("SendSelfId", _this.getSelfInfo);
				_this.signalr.on("ToAdminMessage", _this.fromUserMessage);
				_this.signalr.on("GetHistoryMessage", _this.getHistoryMessage);
				_this.signalr.on("NotifyNewMessage", _this.ReadMessage);
				_this.signalr.on("UnReadMessage", _this.UnReadMessage);
			},
			methods: {
				getSelfInfo: function (id, userid, name, role) {
					let _this = this;
					_this.thisUser.connectionId = id;
					_this.thisUser.userId = userid;
					_this.thisUser.name = name;
					_this.thisUser.role = role;
				},
				sendtoCaller: function () {
					let self = this;
					self.signalr.invoke("SendMessagetoCaller",
						self.message,
						self.currentChatUser.connectionId,
						self.currentChatUser.userId)
						.catch((err) => {
							return console.log(err.toString())
					});
					var newmsg = {
						connectionId: self.thisUser.connectionId,
						message: self.message,
						userId: self.thisUser.userId,
						name: self.thisUser.name,
						role: self.thisUser.role,
						read:false
					};
					var idx = self.allMessage.findIndex(x => x.key == self.currentChatUser.userId)
					self.allMessage[idx].msg.push(newmsg);
					self.message = "";
					self.scroll();
				},
				getAllUsers: function (allusersJson) {
					let self = this;
					var allusers = JSON.parse(allusersJson).map(x => {
						return {
							name: x.Name,
							connectionId: x.ConnectionId,
							userId: x.UserId,
							role: x.Role
						}
					});
					self.UserOn = [];
					for (let user of allusers)
						self.UserOn.push(user)
				},
				UserConnect: function (connectionId, guid, name, role) {
					var idx = this.UserOff.findIndex(x => x.userId == guid)
					if (idx != -1) this.UserOff.splice(idx, 1);
				},
				getOfflineUsers: function (offineUsersJson) {
					let self = this;
					var offineUsers = JSON.parse(offineUsersJson).map(x => {
						return {
							name: x.Name,
							connectionId: x.ConnectionId,
							userId: x.UserId,
							role: x.Role
						}
					});
					self.UserOff = [];
					for (let user of offineUsers)
						self.UserOff.push(user)
				},
				UserDisConnect: function (connectionId, guid, name, role) {
					var idx = this.UserOn.findIndex(x => x.userId == guid)
					if (idx != -1) this.UserOn.splice(idx, 1);
				},
				fromUserMessage: function (connectionId, userId, name, role, message,read) {
					console.log('fromUserMessage');
					var newMsg = {
						connectionId: connectionId,
						message: message,
						userId: userId,
						name: name,
						role: role,
						read:read
					};
					var idx = this.allMessage.findIndex(x => x.key == userId);
					if (idx == -1) {
						var obj = {
							key: userId,
							msg: []
						};
						obj.msg.push(newMsg);
						this.allMessage.push(obj);
					} else {
						this.allMessage[idx].msg.push(newMsg);
					}
					this.scroll();
				},
				UnReadMessage:function(userIds){
					let self=this;
					self.unReadUsers=userIds;
				},
				UnReadNotify:function(userId){
					let self=this;
					for (let id of self.unReadUsers)
					{
						if(id==userId) return
					}
					return "hidden";
				},
				ReadMessage:function(userId){
					let self=this;
					if (this.currentChatUser.userId != userId || this.currentChatUser.userId == "") {
						self.unReadUsers.push(userId);
					}
				},
				IsRead:function(userId){
					let self=this;
					var idx=self.allMessage.findIndex(x=>x.userId==userId)
					var length=self.allMessage[idx].msg.length
					if(self.allMessage[idx].msg[length-1]==true) return hidden;
					else return;
				},
				switchConversation: function (user) {
					let self = this;
					self.currentChatUser = user;
					self.signalr.invoke("GetHistoryMessage", user.userId);
					var idx = self.unReadUsers.findIndex(x=>x.userId);
					self.unReadUsers.splice(idx,1);
					console.table(user);
				},
				getHistoryMessage: function (msgJson) {
					let self = this;
					var obj = JSON.parse(msgJson);
					console.table(obj);
					if (obj == null) return;
					var msgs = obj.map(x => {
						return {
							connectionId: x.Sender.ConnectionId,
							message: x.Message,
							userId: x.Sender.UserId,
							name: x.Sender.Name,
							role: x.Sender.Role,
							read:x.read
						}
					});
					var idx = self.allMessage.findIndex(x => x.key == self.currentChatUser.userId);
					if (idx == -1) {
						var obj = {
							key: self.currentChatUser.userId,
							msg: [],
						};
						for (let m of msgs) {
							obj.msg.push(m);
						}
						self.allMessage.push(obj);
					} else {
						self.allMessage[idx].msg = [];
						self.allMessage[idx].msg = msgs;
					}
					
				},
				scroll:function(){
					document.querySelectorAll('.simplebar-content-wrapper')[1].scroll(0, document.querySelectorAll('.simplebar-content-wrapper')[1].scrollHeight)
				}
			},
		}).mount("#app")

	</script>
}